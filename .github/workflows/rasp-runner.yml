name: Raspberry Pi aarch64 cpu
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Restore Rust and Node.js cache
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.HOME }}/.cargo
            ${{ env.HOME }}/.npm
          key: ${{ runner.os }}-rust-node-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/package-lock.json') }}

      - uses: pguyot/arm-runner-action@v2.5.2
        with:
          image_additional_mb: 10240
          base_image: https://dietpi.com/downloads/images/DietPi_RPi-ARMv8-Bullseye.7z
          cpu: cortex-a53
          commands: |
            apt-get update -y --allow-releaseinfo-change
            apt-get upgrade -y
            apt-get autoremove -y
            apt-get install curl

            # Install Rust (using cached directory if available)
            curl https://sh.rustup.rs -sSf | sh -s -- -y --default-host aarch64-unknown-linux-gnu
            export PATH="$HOME/.cargo/bin:$PATH"

            # Install Node.js (using cached directory if available)
            curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash
            apt-get install -y nodejs

            # Install project dependencies
            npm install next@latest react@latest react-dom@latest eslint-config-next@latest
            apt-get install -y libwebkit2gtk-4.0-dev build-essential wget libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

            # Install Tauri CLI
            cargo install tauri-cli

            # Install project dependencies
            npm install

            # Build with Tauri
            cargo tauri build
